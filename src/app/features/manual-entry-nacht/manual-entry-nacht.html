<div class="main-content">
  <div class="manual-entry-container">
    <!-- Header -->
    <div class="header-row">
      <div>
        <h2>Manuelle Stundeneingabe - Nachtschicht</h2>
        <p class="subtitle">Erfassen Sie Arbeitsstunden der Nachtschicht manuell für Ihre Station</p>
      </div>
    </div>

  <!-- Station Selection / Creation -->
  <mat-card class="selection-card">
    <mat-card-content>
      <div class="selection-row">
        <mat-button-toggle-group [value]="'nacht'" (change)="onShiftToggle($event.value)">
          <mat-button-toggle value="tag">
            <mat-icon>light_mode</mat-icon>
            Tag
          </mat-button-toggle>
          <mat-button-toggle value="nacht">
            <mat-icon>nightlight</mat-icon>
            Nacht
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>

      <!-- Shift times (Tag/Nacht) -->
      <div class="selection-row shift-times">
        <mat-chip-set class="shift-chips">
          <mat-chip>
            <mat-icon>schedule</mat-icon>
            Tag: 06:00–22:00 (16h)
          </mat-chip>
          <mat-chip color="primary" selected>
            <mat-icon>schedule</mat-icon>
            Nacht: 22:00–06:00 (8h)
          </mat-chip>
        </mat-chip-set>
      </div>

      <div class="selection-row">
        <!-- Station Dropdown -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Station auswählen</mat-label>
          <mat-select [value]="selectedStation()" (selectionChange)="onStationChange($event.value)">
            <mat-option value="">-- Bitte wählen --</mat-option>
            <mat-option *ngFor="let station of stations()" [value]="station">
              {{ station }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>business</mat-icon>
          <mat-hint>Stationen aus MiNa/MiTa-Bestände</mat-hint>
        </mat-form-field>
      </div>

      <!-- Year and Month Selection -->
      <div class="selection-row" *ngIf="selectedStation()">
        <mat-form-field appearance="outline">
          <mat-label>Jahr</mat-label>
          <mat-select [value]="selectedYear()" (selectionChange)="onYearChange($event.value)">
            <mat-option *ngFor="let year of availableYears()" [value]="year">
              {{ year }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>calendar_today</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Monat</mat-label>
          <mat-select [value]="selectedMonth()" (selectionChange)="onMonthChange($event.value)">
            <mat-option *ngFor="let month of availableMonths" [value]="month.value">
              {{ month.label }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>event</mat-icon>
        </mat-form-field>
      </div>

      <!-- Kategorie Selection (PFK/PHK) -->
      <div class="kategorie-selection" *ngIf="selectedStation()">
        <div class="kategorie-label">Kategorie:</div>
        <div class="kategorie-buttons">
          <button 
            mat-raised-button 
            *ngFor="let kat of kategorien"
            [color]="selectedKategorie() === kat.value ? 'primary' : ''"
            [class.active]="selectedKategorie() === kat.value"
            (click)="onKategorieChange(kat.value)"
            class="kategorie-btn">
            <mat-icon>{{ kat.value === 'PFK' ? 'verified' : 'support' }}</mat-icon>
            {{ kat.label }}
          </button>
        </div>
      </div>

      <!-- Config Snapshot Info -->
      <div class="config-snapshot-info" *ngIf="selectedStation() && (configSnapshot() || loadingConfigSnapshot())">
        <mat-divider style="margin: 16px 0;"></mat-divider>
        <div class="config-snapshot-header">
          <mat-icon>settings</mat-icon>
          <span class="config-snapshot-title">Verwendete Konfiguration</span>
          <mat-chip *ngIf="configSnapshot()?.isCurrentConfig" color="accent" selected>
            Aktuelle Konfiguration
          </mat-chip>
          <mat-chip *ngIf="configSnapshot() && !configSnapshot()?.isCurrentConfig" color="primary" selected>
            Gespeicherter Snapshot
          </mat-chip>
          <button 
            mat-stroked-button 
            color="primary"
            (click)="openStationConfigDialog()"
            matTooltip="Stationskonfiguration dauerhaft bearbeiten"
            class="edit-config-button">
            <mat-icon>edit</mat-icon>
            Konfiguration bearbeiten
          </button>
        </div>
        <div *ngIf="loadingConfigSnapshot()" class="config-loading">
          <mat-progress-spinner mode="indeterminate" diameter="20"></mat-progress-spinner>
          <span>Lade Konfiguration...</span>
        </div>
        <div *ngIf="configSnapshot() && !loadingConfigSnapshot()" class="config-values">
          <div class="config-item">
            <span class="config-label">Schichtstunden ({{ configSnapshot()!.schicht === 'tag' ? 'Tag' : 'Nacht' }}):</span>
            <span class="config-value">{{ configSnapshot()!.schicht_stunden_used }}h</span>
          </div>
          <div class="config-item" *ngIf="configSnapshot()!.phk_anteil_base_used !== null">
            <span class="config-label">PHK-Anteil Basis:</span>
            <span class="config-value">{{ configSnapshot()!.phk_anteil_base_used }}</span>
          </div>
          <div class="config-item">
            <span class="config-label">P:P-Ratio Basis ({{ configSnapshot()!.schicht === 'tag' ? 'Tag' : 'Nacht' }}):</span>
            <span class="config-value">{{ configSnapshot()!.pp_ratio_base_used }}</span>
          </div>
          <div class="config-timestamp" *ngIf="configSnapshot()!.erstellt_am">
            <mat-icon>schedule</mat-icon>
            <span>Gespeichert am: {{ configSnapshot()!.erstellt_am | date:'dd.MM.yyyy HH:mm' }}</span>
            <span *ngIf="configSnapshot()!.aktualisiert_am && configSnapshot()!.aktualisiert_am !== configSnapshot()!.erstellt_am">
              (Aktualisiert: {{ configSnapshot()!.aktualisiert_am | date:'dd.MM.yyyy HH:mm' }})
            </span>
          </div>
          <div class="config-message" *ngIf="configSnapshot()!.message">
            <mat-icon>info</mat-icon>
            <span>{{ configSnapshot()!.message }}</span>
          </div>
        </div>
      </div>

      <!-- File Upload Section -->
      <div class="upload-section">
        <mat-divider style="margin: 20px 0;"></mat-divider>
        <div class="upload-header">
          <mat-icon>cloud_upload</mat-icon>
          <h3>Dienstplan-Excel hochladen</h3>
        </div>
        <p class="upload-description">
          Laden Sie eine Dienstplan-Excel-Datei (DP9) hoch, um Arbeitszeiten automatisch zu importieren.
        </p>
        <div class="variant-selection" style="margin-bottom: 16px;">
          <mat-form-field appearance="outline" style="width: 100%;">
            <mat-label>Berechnungsvariante</mat-label>
            <mat-select [value]="selectedVariant()" (selectionChange)="selectedVariant.set($event.value)">
              <mat-option value="legacy">
                <div style="display: flex; flex-direction: column;">
                  <strong>Legacy (bis 2025)</strong>
                  <span style="font-size: 0.85em; color: #666;">Verwendet "Ist"-Zeilen direkt</span>
                </div>
              </mat-option>
              <mat-option value="2026">
                <div style="display: flex; flex-direction: column;">
                  <strong>2026 (ab 2026)</strong>
                  <span style="font-size: 0.85em; color: #666;">Verwendet PPUG-Zeilen nach neuen Regeln</span>
                </div>
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>settings</mat-icon>
            <mat-hint>Wählen Sie die Berechnungsvariante basierend auf dem Jahr der Daten</mat-hint>
          </mat-form-field>
        </div>
        <div class="upload-controls">
          <input 
            #fileInput 
            type="file" 
            accept=".xlsx,.xls" 
            (change)="onFileSelected($event)"
            style="display: none;">
          <button 
            mat-stroked-button 
            (click)="triggerFileSelect()"
            [disabled]="uploading()">
            <mat-icon>folder_open</mat-icon>
            Datei auswählen
          </button>
          <button 
            mat-raised-button 
            color="primary"
            (click)="uploadDienstplan()"
            [disabled]="!selectedFile() || uploading()">
            <mat-spinner *ngIf="uploading()" diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
            <mat-icon *ngIf="!uploading()">upload</mat-icon>
            {{ uploading() ? 'Wird hochgeladen...' : 'Dienstplan hochladen' }}
          </button>
          <button 
            mat-icon-button 
            *ngIf="selectedFile()"
            (click)="clearSelectedFile()"
            color="warn">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="selected-file" *ngIf="selectedFile()">
          <mat-icon>description</mat-icon>
          <span>{{ selectedFile()?.name }}</span>
          <span class="file-size">({{ ((selectedFile()?.size || 0) / 1024) | number:'1.0-1' }} KB)</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Statistics Card -->
  <mat-card class="stats-card" *ngIf="selectedStation() && !loading()">
    <mat-card-content>
      <div class="stats-row">
        <div class="stat-item">
          <mat-icon>access_time</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Gesamt</span>
            <span class="stat-value">{{ getTotalHours() }} Stunden</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('gesamt')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>
        
        <div class="stat-item">
          <mat-icon>avg_pace</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Durchschnitt {{ selectedKategorie() }}</span>
            <span class="stat-value">{{ getAverageHoursPerDay() }} Stunden/Tag</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('durchschnitt')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <div class="stat-item">
          <mat-icon>calendar_month</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Tage im Monat</span>
            <span class="stat-value">{{ daysInMonth() }} Tage</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('tageImMonat')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <!-- PHK-Anteil (nur PFK) -->
        <div class="stat-item" *ngIf="selectedKategorie() === 'PFK'">
          <mat-icon>percent</mat-icon>
          <div class="stat-content">
            <span class="stat-label">PHK-Anteil (Nacht)</span>
            <span class="stat-value">{{ getPhkAnteilPercent() }}</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('phkAnteil')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <div class="stat-item phk-stat" *ngIf="selectedKategorie() === 'PFK' && durchschnittPhkAnrechenbar() !== null">
          <mat-icon>trending_up</mat-icon>
          <div class="stat-content">
            <span class="stat-label">⌀ Anrechenbare AZ PHK</span>
            <span class="stat-value highlight">{{ durchschnittPhkAnrechenbar()?.toFixed(2) }} h/Tag</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('phkAnrechenbar')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <div class="stat-item gesamt-stat" *ngIf="selectedKategorie() === 'PFK' && getGesamtAnrechenbar() !== null">
          <mat-icon>calculate</mat-icon>
          <div class="stat-content">
            <span class="stat-label">⌀ Gesamt Anrechenbar</span>
            <span class="stat-value gesamt-highlight">{{ getGesamtAnrechenbar() }} h/Tag</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('gesamtAnrechenbar')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <div class="stat-item exam-stat" *ngIf="selectedKategorie() === 'PFK' && getExamPflege() !== null">
          <mat-icon>school</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Exam. Pflege</span>
            <span class="stat-value exam-highlight">{{ getExamPflegeFormatted() }}</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('examPflege')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <div class="stat-item patienten-stat" *ngIf="selectedKategorie() === 'PFK' && getPatientenProPflegekraft() !== null">
          <mat-icon>groups</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Patienten/Pflegekraft</span>
            <span class="stat-value patienten-highlight">{{ getPatientenProPflegekraft() }}</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('patientenProPflegekraft')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <div class="stat-item ppugv-prozent-stat" *ngIf="selectedKategorie() === 'PFK' && getPpugvErfuelltNeinProzent() !== null">
          <mat-icon>check_circle</mat-icon>
          <div class="stat-content">
            <span class="stat-label">PpUG erfüllt %</span>
            <span class="stat-value ppugv-prozent-highlight">{{ getPpugvErfuelltNeinProzent()!.toFixed(2) }}%</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('ppugvErfuelltProzent')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <div class="stat-item delta-soll-ist-stat" *ngIf="selectedKategorie() === 'PFK' && getDeltaSollIstPflegfachkraft() !== null">
          <mat-icon>trending_up</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Delta Soll-Ist Pflegfachkraft</span>
            <span class="stat-value delta-highlight">{{ getDeltaSollIstPflegfachkraft()!.toFixed(4) }}</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('deltaSollIst')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <div class="stat-item pp-ratio-stat" *ngIf="selectedKategorie() === 'PFK' && getPPRatio() !== null">
          <mat-icon>calculate</mat-icon>
          <div class="stat-content">
            <span class="stat-label">P:P</span>
            <span class="stat-value pp-ratio-highlight">{{ getPPRatio()!.toFixed(2) }}</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('ppRatio')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <!-- Stats aus header-calculations -->
        <div class="stat-item" *ngIf="selectedKategorie() === 'PFK' && belegteBettenKonstante() !== null">
          <mat-icon>bed</mat-icon>
          <div class="stat-content">
            <span class="stat-label">MiNa Bestände-Ø Station</span>
            <span class="stat-value">{{ belegteBettenKonstante()!.toFixed(2) }}</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('minaDurchschnitt')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <div class="stat-item" *ngIf="selectedKategorie() === 'PFK' && getDurchschnittPpugNachPfk() !== null">
          <mat-icon>trending_up</mat-icon>
          <div class="stat-content">
            <span class="stat-label">PpUG nach PFK Ø</span>
            <span class="stat-value">{{ getDurchschnittPpugNachPfk() }}</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('ppugNachPfkDurchschnitt')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <div class="stat-item" *ngIf="selectedKategorie() === 'PFK' && getDurchschnittPfkNormal() !== null">
          <mat-icon>person</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Ergibt PFK Ø</span>
            <span class="stat-value">{{ getDurchschnittPfkNormal() }}</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('pfkNormalDurchschnitt')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <div class="stat-item" *ngIf="selectedKategorie() === 'PFK' && getDurchschnittTatsaechlichAnrechenbar() !== null">
          <mat-icon>check_circle</mat-icon>
          <div class="stat-content">
            <span class="stat-label">⌀ Tatsächlich Anrechenbar</span>
            <span class="stat-value">{{ getDurchschnittTatsaechlichAnrechenbar() }}</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('tatsaechlichAnrechenbar')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <div class="stat-item" *ngIf="selectedKategorie() === 'PFK' && getAnzahlPpugvErfuelltNein() !== null">
          <mat-icon>cancel</mat-icon>
          <div class="stat-content">
            <span class="stat-label">PpUG erfüllt Nein</span>
            <span class="stat-value">{{ getAnzahlPpugvErfuelltNein() }}</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('ppugvErfuelltNein')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <div class="stat-item geleistete-phk-stat" *ngIf="selectedKategorie() === 'PFK' && geleistetePhkStunden() !== null">
          <mat-icon>work</mat-icon>
          <div class="stat-content">
            <span class="stat-label">⌀ Geleistete AZ PHK</span>
            <span class="stat-value geleistete-phk-highlight">{{ getGeleistetePhkStundenFormatted() }}</span>
          </div>
          <button mat-icon-button class="stat-info-button" (click)="openStatInfoModal('geleistetePhk')" matTooltip="Berechnung anzeigen">
            <mat-icon>info</mat-icon>
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Data Entry Table -->
  <mat-card class="data-entry-card" *ngIf="selectedStation()">
    <mat-card-header>
      <div class="header-title-section">
        <mat-card-title>
          <mat-icon>grid_on</mat-icon>
          {{ getMonthName(selectedMonth()) }} {{ selectedYear() }} - {{ selectedStation() }} ({{ selectedKategorie() }})
        </mat-card-title>
      </div>
      
      <div class="header-actions">
        <button mat-raised-button color="accent" (click)="exportPpugMeldung()" [disabled]="saving()">
          <mat-icon>download</mat-icon>
          {{ saving() ? 'Exportiert...' : 'PPUG Meldung' }}
        </button>
        <button mat-raised-button color="primary" (click)="saveData()" [disabled]="saving()">
          <mat-icon>save</mat-icon>
          {{ saving() ? 'Speichert...' : 'Manuell Speichern' }}
        </button>
        <button 
          mat-raised-button 
          color="accent" 
          (click)="recomputeData()" 
          [disabled]="recomputing() || saving() || !selectedStation() || !hasData()"
          matTooltip="Berechnete Werte (PFK Normal, Gesamt PFK/PHK, PHK End, PHK Anrechenbar) mit aktueller Konfiguration neu berechnen">
          <mat-icon>refresh</mat-icon>
          {{ recomputing() ? 'Neuberechnung...' : 'Neuberechnen' }}
        </button>
      </div>
    </mat-card-header>

    <mat-card-content>
      <div class="loading-spinner" *ngIf="loading()">
        <mat-spinner></mat-spinner>
        <p>Daten werden geladen...</p>
      </div>

      <div class="entry-table-container" *ngIf="!loading()">
        <table class="entry-table">
          <thead>
            <!-- Gruppen-Header für Soll/Ist-Arbeitszeit -->
            <tr class="group-header-row">
              <th colspan="4" class="base-columns-header"></th>
              <th colspan="3" class="soll-arbeitszeit-header">
                <div class="group-header-label">
                  <mat-icon>schedule</mat-icon>
                  <span>Soll-Arbeitszeit</span>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" colspan="9" class="ist-arbeitszeit-header">
                <div class="group-header-label">
                  <mat-icon>check_circle</mat-icon>
                  <span>Ist-Arbeitszeit</span>
                </div>
              </th>
            </tr>
            <!-- Spalten-Header -->
            <tr>
              <th>Tag</th>
              <th>Stunden</th>
              <th>Minuten</th>
              <th>Gesamt</th>
              <th class="phk-column soll-column">
                <div class="header-with-info">
                  <span>MiNa Bestände</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('mina')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th class="phk-column soll-column">
                <div class="header-with-info">
                  <span>PpUG nach PFK</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('ppugNachPfk')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th class="phk-column soll-column">
                <div class="header-with-info">
                  <span>in Std.</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('ppugInStunden')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column">
                <div class="header-with-info">
                  <span>PpUG erfüllt</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('ppugErfuellt')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column ist-column">
                <div class="header-with-info">
                  <span>Ergibt PFK</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('pfkNormal')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column ist-column">
                <div class="header-with-info">
                  <span>Gesamt PFK+PHK</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('gesamtPfkPhk')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column ist-column">
                <div class="header-with-info">
                  <span>davon PHK</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('phkEnd')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column ist-column">
                <div class="header-with-info">
                  <span>Anrechenbare AZ PHK</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('phkAnrechenbar')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column geleistete-phk-column ist-column">
                <div class="header-with-info">
                  <span>Geleistete AZ PHK in Std</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('geleistetePhk')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column tatsaechlich-column ist-column">
                <div class="header-with-info">
                  <span>tatsächl. Anrechenbar</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('tatsaechlichAnrechenbar')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column gesamte-anrech-column ist-column">
                <div class="header-with-info">
                  <span>Gesamte anrechb. AZ:</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('gesamteAnrechbareAZ')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column exam-pflege-column ist-column">
                <div class="header-with-info">
                  <span>Exam. Pflege</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('examPflege')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column ppug-erfuellt-v2-column ist-column">
                <div class="header-with-info">
                  <span>PpUG erfüllt</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('ppugErfuelltV2')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let entry of dayEntries(); let i = index; trackBy: trackByTag" [class.even-row]="i % 2 === 0">
              <td class="day-cell">
                <mat-icon class="small-icon">event</mat-icon>
                <strong>{{ entry.tag }}</strong>
              </td>
              <td class="input-cell">
                <input 
                  type="number" 
                  min="0" 
                  [value]="entry.stunden"
                  (input)="updateEntry(i, 'stunden', $any($event.target).value)"
                  placeholder="0"
                  class="table-input">
              </td>
              <td class="input-cell">
                <input 
                  type="number" 
                  min="0" 
                  max="59" 
                  [value]="entry.minuten"
                  (input)="updateEntry(i, 'minuten', $any($event.target).value)"
                  placeholder="0"
                  class="table-input">
              </td>
              <td class="total-cell">
                <span class="total-badge">
                  {{ entry.stunden }}:{{ entry.minuten.toString().padStart(2, '0') }}h
                </span>
              </td>
              <td class="phk-value-cell soll-cell">
                <span class="mina-value">{{ getMinaForTag(entry.tag) }}</span>
              </td>
              <td class="phk-value-cell soll-cell">
                <span class="ppug-value">{{ getPpugNachPfkForTag(entry.tag) }}</span>
              </td>
              <td class="phk-value-cell soll-cell">
                <span class="ppug-stunden-value">{{ getPpugNachPfkInStundenForTag(entry.tag) }}</span>
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell ppugv-cell"
                  [class.ppugv-nein]="getPpugErfuelltForTag(entry) === 'Nein'">
                <span [class.ppug-ja]="getPpugErfuelltForTag(entry) === 'Ja'" 
                      [class.ppug-nein]="getPpugErfuelltForTag(entry) === 'Nein'">
                  {{ getPpugErfuelltForTag(entry) }}
                </span>
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell ist-cell">
                {{ getPhkValue(entry, 'pfkNormal') }}
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell ist-cell">
                {{ getPhkValue(entry, 'gesamtPfkPhk') }}
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell ist-cell">
                {{ getPhkValue(entry, 'phkEnd') }}
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell highlight ist-cell">
                <strong>{{ getPhkValue(entry, 'phkAnrechenbar') }}h</strong>
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell geleistete-phk-cell ist-cell">
                <span class="geleistete-phk-value">
                  {{ getPhkStundenForTag(entry.tag) }}
                </span>
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell tatsaechlich-cell ist-cell">
                <span class="tatsaechlich-value">
                  {{ getTatsaechlichAnrechenbarForTag(entry) }}
                </span>
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell gesamte-anrech-cell ist-cell">
                <span class="gesamte-anrech-value">
                  {{ getGesamteAnrechbareAZForTag(entry) }}
                </span>
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell exam-pflege-cell ist-cell">
                <span class="exam-pflege-value">
                  {{ getExamPflegeForTag(entry) }}
                </span>
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell ppugv-cell ppug-erfuellt-v2-cell"
                  [class.ppugv-nein]="getPpugErfuelltV2ForTag(entry) === 'Nein'">
                <span [class.ppug-ja]="getPpugErfuelltV2ForTag(entry) === 'Ja'" 
                      [class.ppug-nein]="getPpugErfuelltV2ForTag(entry) === 'Nein'">
                  {{ getPpugErfuelltV2ForTag(entry) }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="auto-save-indicator" *ngIf="saving()">
        <mat-spinner diameter="16"></mat-spinner>
        <span>Speichert...</span>
      </div>
    </mat-card-content>
  </mat-card>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!selectedStation()">
      <mat-icon>business</mat-icon>
      <h3>Keine Station ausgewählt</h3>
      <p>Wählen Sie eine Station aus den MiNa/MiTa-Beständen aus, um mit der Nachtschicht-Stundeneingabe zu beginnen.</p>
    </div>
  </div>
</div>


<div class="manual-entry-container">
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>edit_calendar</mat-icon>
        Manuelle Stundeneingabe
      </mat-card-title>
      <mat-card-subtitle>
        Erfassen Sie Arbeitsstunden manuell für Ihre Station
      </mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <!-- Station Selection / Creation -->
  <mat-card class="selection-card">
    <mat-card-content>
      <div class="selection-row">
        <mat-button-toggle-group [value]="'tag'" (change)="onShiftToggle($event.value)">
          <mat-button-toggle value="tag">
            <mat-icon>light_mode</mat-icon>
            Tag
          </mat-button-toggle>
          <mat-button-toggle value="nacht">
            <mat-icon>nightlight</mat-icon>
            Nacht
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>

      <!-- Shift times (Tag/Nacht) -->
      <div class="selection-row shift-times">
        <mat-chip-set class="shift-chips">
          <mat-chip color="primary" selected>
            <mat-icon>schedule</mat-icon>
            Tag: 06:00–22:00 (16h)
          </mat-chip>
          <mat-chip>
            <mat-icon>schedule</mat-icon>
            Nacht: 22:00–06:00 (8h)
          </mat-chip>
        </mat-chip-set>
      </div>

      <div class="selection-row">
        <!-- Station Dropdown -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Station auswählen</mat-label>
          <mat-select [value]="selectedStation()" (selectionChange)="onStationChange($event.value)">
            <mat-option value="">-- Bitte wählen --</mat-option>
            <mat-option *ngFor="let station of stations()" [value]="station">
              {{ station }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>business</mat-icon>
          <mat-hint>Stationen aus MiNa/MiTa-Bestände</mat-hint>
        </mat-form-field>
        
        <!-- Button zum Löschen aller Daten für diese Station -->
        <button 
          mat-raised-button 
          color="warn" 
          (click)="clearAllMonthsForStation()" 
          [disabled]="!selectedStation() || saving()"
          class="delete-all-station-btn">
          <mat-icon>delete_forever</mat-icon>
          <span *ngIf="!saving()">Alle Monate zurücksetzen</span>
          <span *ngIf="saving()">Löscht...</span>
        </button>
      </div>

      <!-- Year and Month Selection -->
      <div class="selection-row" *ngIf="selectedStation()">
        <mat-form-field appearance="outline">
          <mat-label>Jahr</mat-label>
          <mat-select [value]="selectedYear()" (selectionChange)="onYearChange($event.value)">
            <mat-option *ngFor="let year of availableYears()" [value]="year">
              {{ year }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>calendar_today</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Monat</mat-label>
          <mat-select [value]="selectedMonth()" (selectionChange)="onMonthChange($event.value)">
            <mat-option *ngFor="let month of availableMonths" [value]="month.value">
              {{ month.label }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>event</mat-icon>
        </mat-form-field>
      </div>

      <!-- Kategorie Selection (PFK/PHK) -->
      <div class="kategorie-selection" *ngIf="selectedStation()">
        <div class="kategorie-label">Kategorie:</div>
        <div class="kategorie-buttons">
          <button 
            mat-raised-button 
            *ngFor="let kat of kategorien"
            [color]="selectedKategorie() === kat.value ? 'primary' : ''"
            [class.active]="selectedKategorie() === kat.value"
            (click)="onKategorieChange(kat.value)"
            class="kategorie-btn">
            <mat-icon>{{ kat.value === 'PFK' ? 'verified' : 'support' }}</mat-icon>
            {{ kat.label }}
          </button>
        </div>
      </div>

      <!-- File Upload Section -->
      <div class="upload-section">
        <mat-divider style="margin: 20px 0;"></mat-divider>
        <div class="upload-header">
          <mat-icon>cloud_upload</mat-icon>
          <h3>Dienstplan-Excel hochladen</h3>
        </div>
        <p class="upload-description">
          Laden Sie eine Dienstplan-Excel-Datei (DP9) hoch, um Arbeitszeiten automatisch zu importieren.
        </p>
        <div class="variant-selection" style="margin-bottom: 16px;">
          <mat-form-field appearance="outline" style="width: 100%;">
            <mat-label>Berechnungsvariante</mat-label>
            <mat-select [value]="selectedVariant()" (selectionChange)="selectedVariant.set($event.value)">
              <mat-option value="legacy">
                <div style="display: flex; flex-direction: column;">
                  <strong>Legacy (bis 2025)</strong>
                  <span style="font-size: 0.85em; color: #666;">Verwendet "Ist"-Zeilen direkt</span>
                </div>
              </mat-option>
              <mat-option value="2026">
                <div style="display: flex; flex-direction: column;">
                  <strong>2026 (ab 2026)</strong>
                  <span style="font-size: 0.85em; color: #666;">Verwendet PPUG-Zeilen nach neuen Regeln</span>
                </div>
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>settings</mat-icon>
            <mat-hint>Wählen Sie die Berechnungsvariante basierend auf dem Jahr der Daten</mat-hint>
          </mat-form-field>
        </div>
        <div class="upload-controls">
          <input 
            #fileInput 
            type="file" 
            accept=".xlsx,.xls" 
            (change)="onFileSelected($event)"
            style="display: none;">
          <button 
            mat-stroked-button 
            (click)="triggerFileSelect()"
            [disabled]="uploading()">
            <mat-icon>folder_open</mat-icon>
            Datei auswählen
          </button>
          <button 
            mat-raised-button 
            color="primary"
            (click)="uploadDienstplan()"
            [disabled]="!selectedFile() || uploading()">
            <mat-spinner *ngIf="uploading()" diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
            <mat-icon *ngIf="!uploading()">upload</mat-icon>
            {{ uploading() ? 'Wird hochgeladen...' : 'Dienstplan hochladen' }}
          </button>
          <button 
            mat-icon-button 
            *ngIf="selectedFile()"
            (click)="clearSelectedFile()"
            color="warn">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="selected-file" *ngIf="selectedFile()">
          <mat-icon>description</mat-icon>
          <span>{{ selectedFile()?.name }}</span>
          <span class="file-size">({{ ((selectedFile()?.size || 0) / 1024) | number:'1.0-1' }} KB)</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Statistics Card -->
  <mat-card class="stats-card" *ngIf="selectedStation() && !loading()">
    <mat-card-content>
      <div class="stats-row">
        <div class="stat-item">
          <mat-icon>access_time</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Gesamt</span>
            <span class="stat-value">{{ getTotalHours() }} Stunden</span>
          </div>
        </div>
        
        <div class="stat-item">
          <mat-icon>avg_pace</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Durchschnitt {{ selectedKategorie() }}</span>
            <span class="stat-value">{{ getAverageHoursPerDay() }} Stunden/Tag</span>
          </div>
        </div>

        <div class="stat-item">
          <mat-icon>calendar_month</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Tage im Monat</span>
            <span class="stat-value">{{ daysInMonth() }} Tage</span>
          </div>
        </div>

        <!-- PHK-Anteil (nur PFK) -->
        <div class="stat-item" *ngIf="selectedKategorie() === 'PFK'">
          <mat-icon>percent</mat-icon>
          <div class="stat-content">
            <span class="stat-label">PHK-Anteil</span>
            <span class="stat-value">90%</span>
          </div>
        </div>

        <div class="stat-item phk-stat" *ngIf="selectedKategorie() === 'PFK' && durchschnittPhkAnrechenbar() !== null">
          <mat-icon>trending_up</mat-icon>
          <div class="stat-content">
            <span class="stat-label">⌀ PHK Anrechenbar</span>
            <span class="stat-value highlight">{{ durchschnittPhkAnrechenbar()?.toFixed(2) }} h/Tag</span>
          </div>
        </div>

        <div class="stat-item gesamt-stat" *ngIf="selectedKategorie() === 'PFK' && getGesamtAnrechenbar() !== null">
          <mat-icon>calculate</mat-icon>
          <div class="stat-content">
            <span class="stat-label">⌀ Gesamt Anrechenbar</span>
            <span class="stat-value gesamt-highlight">{{ getGesamtAnrechenbar() }} h/Tag</span>
          </div>
        </div>

        <div class="stat-item exam-stat" *ngIf="selectedKategorie() === 'PFK' && getExamPflege() !== null">
          <mat-icon>school</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Exam. Pflege</span>
            <span class="stat-value exam-highlight">{{ getExamPflegeFormatted() }}</span>
          </div>
        </div>

        <div class="stat-item patienten-stat" *ngIf="selectedKategorie() === 'PFK' && getPatientenProPflegekraft() !== null">
          <mat-icon>groups</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Patienten/Pflegekraft</span>
            <span class="stat-value patienten-highlight">{{ getPatientenProPflegekraft() }}</span>
          </div>
        </div>

        <div class="stat-item geleistete-phk-stat" *ngIf="selectedKategorie() === 'PFK' && geleistetePhkStunden() !== null">
          <mat-icon>work</mat-icon>
          <div class="stat-content">
            <span class="stat-label">⌀ Geleistete AZ PHK</span>
            <span class="stat-value geleistete-phk-highlight">{{ getGeleistetePhkStundenFormatted() }}</span>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Data Entry Table -->
  <mat-card class="data-entry-card" *ngIf="selectedStation()">
    <mat-card-header>
      <div class="header-title-section">
        <mat-card-title>
          <mat-icon>grid_on</mat-icon>
          {{ getMonthName(selectedMonth()) }} {{ selectedYear() }} - {{ selectedStation() }} ({{ selectedKategorie() }})
        </mat-card-title>
        
        <!-- Berechnete Werte (nur bei PFK) -->
        <div class="header-calculations" *ngIf="selectedKategorie() === 'PFK' && durchschnittPhkAnrechenbar() !== null">
          <div class="calc-item">
            <span class="calc-label">MiTa-Ø Station:</span>
            <span class="calc-value konstante">{{ belegteBettenKonstante().toFixed(2) }}</span>
          </div>
          <div class="calc-separator">|</div>
          <div class="calc-item">
            <span class="calc-label">Exam. Pflege:</span>
            <span class="calc-value">{{ getExamPflegeFormatted() }}</span>
          </div>
          <div class="calc-separator">|</div>
          <div class="calc-item">
            <span class="calc-label">Patienten/Pflegekraft:</span>
            <span class="calc-value highlight">{{ getPatientenProPflegekraft() }}</span>
          </div>
          <div class="calc-separator" *ngIf="geleistetePhkStunden() !== null">|</div>
          <div class="calc-item" *ngIf="geleistetePhkStunden() !== null">
            <span class="calc-label">Geleistete AZ PHK:</span>
            <span class="calc-value geleistete-phk">{{ getGeleistetePhkStundenFormatted() }}</span>
          </div>
        </div>
      </div>
      
      <div class="header-actions">
        <button mat-button color="warn" (click)="clearAllEntries()" [disabled]="saving()">
          <mat-icon>delete_sweep</mat-icon>
          <span *ngIf="!saving()">Alle {{ selectedKategorie() }} zurücksetzen</span>
          <span *ngIf="saving()">Löscht...</span>
        </button>
        <button mat-button color="warn" (click)="clearAllStationData()" [disabled]="saving()">
          <mat-icon>delete_forever</mat-icon>
          {{ saving() ? 'Löscht...' : 'Alle Stunden (PFK + PHK) löschen' }}
        </button>
        <button mat-raised-button color="primary" (click)="saveData()" [disabled]="saving()">
          <mat-icon>save</mat-icon>
          {{ saving() ? 'Speichert...' : 'Manuell Speichern' }}
        </button>
      </div>
    </mat-card-header>

    <mat-card-content>
      <div class="loading-spinner" *ngIf="loading()">
        <mat-spinner></mat-spinner>
        <p>Daten werden geladen...</p>
      </div>

      <div class="entry-table-container" *ngIf="!loading()">
        <table class="entry-table">
          <thead>
            <tr>
              <th>Tag</th>
              <th>Stunden</th>
              <th>Minuten</th>
              <th>Gesamt</th>
              <th class="action-column">Reset</th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column">
                <div class="header-with-info">
                  <span>PFK Normal</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('pfkNormal')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column">
                <div class="header-with-info">
                  <span>Gesamt PFK+PHK</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('gesamtPfkPhk')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column">
                <div class="header-with-info">
                  <span>PHK End</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('phkEnd')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column">
                <div class="header-with-info">
                  <span>PHK Anrechenbar</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('phkAnrechenbar')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column geleistete-phk-column">
                <div class="header-with-info">
                  <span>Geleistete AZ PHK in Std</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('geleistetePhk')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
              <th *ngIf="selectedKategorie() === 'PFK'" class="phk-column tatsaechlich-column">
                <div class="header-with-info">
                  <span>tatsächl. Anrechenbar</span>
                  <button mat-icon-button class="info-button" (click)="openCalculationModal('tatsaechlichAnrechenbar')" matTooltip="Berechnung anzeigen">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let entry of dayEntries(); let i = index; trackBy: trackByTag" [class.even-row]="i % 2 === 0">
              <td class="day-cell">
                <mat-icon class="small-icon">event</mat-icon>
                <strong>{{ entry.tag }}</strong>
              </td>
              <td class="input-cell">
                <input 
                  type="number" 
                  min="0" 
                  [value]="entry.stunden"
                  (input)="updateEntry(i, 'stunden', $any($event.target).value)"
                  placeholder="0"
                  class="table-input">
              </td>
              <td class="input-cell">
                <input 
                  type="number" 
                  min="0" 
                  max="59" 
                  [value]="entry.minuten"
                  (input)="updateEntry(i, 'minuten', $any($event.target).value)"
                  placeholder="0"
                  class="table-input">
              </td>
              <td class="total-cell">
                <span class="total-badge">
                  {{ entry.stunden }}:{{ entry.minuten.toString().padStart(2, '0') }}h
                </span>
              </td>
              <td class="action-cell">
                <button 
                  mat-icon-button 
                  color="warn" 
                  (click)="resetSingleDay(i)"
                  matTooltip="Tag zurücksetzen"
                  *ngIf="entry.stunden > 0 || entry.minuten > 0">
                  <mat-icon>refresh</mat-icon>
                </button>
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell">
                {{ getPhkValue(entry, 'pfkNormal') }}
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell">
                {{ getPhkValue(entry, 'gesamtPfkPhk') }}
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell">
                {{ getPhkValue(entry, 'phkEnd') }}
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell highlight">
                <strong>{{ getPhkValue(entry, 'phkAnrechenbar') }}h</strong>
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell geleistete-phk-cell">
                <span class="geleistete-phk-value">
                  {{ getPhkStundenForTag(entry.tag) }}
                </span>
              </td>
              <td *ngIf="selectedKategorie() === 'PFK'" class="phk-value-cell tatsaechlich-cell">
                <span class="tatsaechlich-value">
                  {{ getTatsaechlichAnrechenbarForTag(entry) }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="auto-save-indicator" *ngIf="saving()">
        <mat-spinner diameter="16"></mat-spinner>
        <span>Speichert...</span>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Empty State -->
  <mat-card class="empty-state" *ngIf="!selectedStation()">
    <mat-card-content>
      <mat-icon>business</mat-icon>
      <h3>Keine Station ausgewählt</h3>
      <p>Wählen Sie eine Station aus den MiNa/MiTa-Beständen aus, um mit der Stundeneingabe zu beginnen.</p>
    </mat-card-content>
  </mat-card>
</div>

